window.addEventListener("beforeunload",(function(e){e.preventDefault(),e.returnValue=""}));const VERSION=5;let db;function openDBandWrite(){console.log("Encountered Error, attempting to recover");let e=indexedDB.open("db",5);e.onsuccess=function(t){console.log("Success creating/accessing IndexedDB database"),db=e.result,db.onerror=function(){console.log("Error creating/accessing IndexedDB database")},db.transaction(["ObjectStore"],"readwrite").objectStore("ObjectStore").put(container,"container").onsuccess=()=>{showMessage("Created Cache","palegreen")}},e.onupgradeneeded=function(t){db=e.result,db.createObjectStore("ObjectStore")},e.onerror=function(){console.error("Error",e.error)}}function openDBandRead(){let e=indexedDB.open("db",5);e.onsuccess=function(t){db=e.result,db.onerror=function(){console.log("Error creating/accessing IndexedDB database")};const n=db.transaction(["ObjectStore"],"readonly").objectStore("ObjectStore").get("container");n.onsuccess=()=>{const e=n.result;void 0===e?showMessage("No Data Found","red"):(container=e,showMessage("Cache Success","palegreen"),renderFirst(),switchContainers())}},e.onupgradeneeded=function(t){db=e.result,db.createObjectStore("ObjectStore")},e.onerror=function(){console.error("Error",e.error)}}function storeData(){if(null==db)openDBandWrite();else{db.transaction(["ObjectStore"],"readwrite").objectStore("ObjectStore").put(container,"container").onsuccess=()=>{showMessage("Updated Cache","palegreen")}}}function showMessage(e,t){document.getElementById("messages").style.color=t,document.getElementById("messages").innerText=e,setTimeout(()=>{document.getElementById("messages").innerText="Participation",document.getElementById("messages").style.color="rgb(224,224,224)"},2e3)}var container,search_array,search_period,current_sort="alpha",sorts=new Map,is_search=!1;class Student{constructor(e,t,n){this.first=e,this.last=t,this.points=parseInt(n),this.init_points=parseInt(n),this.alpha_pos=0}}function readFile(e){var t=e.target.files[0];if(t){var n=new FileReader;return n.onload=function(e){var t=e.target.result,n=$.csv.toObjects(t),r=new Map;for(var a in n){var s=n[a];if(r.has(s.period))r.get(s.period).push(new Student(s.first,s.last,s.points));else r.set(s.period,new Array(new Student(s.first,s.last,s.points)))}container=new Map([...r.entries()].sort()),renderFirst(),switchContainers(),storeData()},n.readAsText(t)}}function readText(){var e=$.csv.toObjects(document.getElementById("textarea").value),t=new Map;for(var n in e){var r=e[n];if(t.has(r.period))t.get(r.period).push(new Student(r.first,r.last,r.points)),sorts.set(r.period,"alpha");else t.set(r.period,new Array(new Student(r.first,r.last,r.points)))}container=new Map([...t.entries()].sort()),renderFirst(),switchContainers(),storeData()}function switchContainers(){document.getElementById("first-container").hidden=!0,document.getElementById("second-container").hidden=!1}function sortAlpha(){for(var[,e]of container)for(var t in e.sort((e,t)=>e.last.toUpperCase()==t.last.toUpperCase()?e.first.toUpperCase()<t.first.toUpperCase()?-1:1:e.last.toUpperCase()<t.last.toUpperCase()?-1:1),e)e[t].alpha_pos=t}function sortAlphaTab(e){(is_search?search_array:container.get(e.toString())).sort((e,t)=>e.last.toUpperCase()==t.last.toUpperCase()?e.first.toUpperCase()<t.first.toUpperCase()?-1:1:e.last.toUpperCase()<t.last.toUpperCase()?-1:1),current_sort="alpha",sorts.set(e,"alpha"),rerender(e)}function sortDescendTab(e){(is_search?search_array:container.get(e.toString())).sort((e,t)=>t.points-t.init_points-(e.points-e.init_points)==0?e.last.toUpperCase()==t.last.toUpperCase()?e.first.toUpperCase()<t.first.toUpperCase()?-1:1:e.last.toUpperCase()<t.last.toUpperCase()?-1:1:t.points-t.init_points-(e.points-e.init_points)),current_sort="descend",sorts.set(e,"descend"),rerender(e)}function sortAscendTab(e){(is_search?search_array:container.get(e.toString())).sort((e,t)=>e.points-t.points==0?e.last.toUpperCase()==t.last.toUpperCase()?e.first.toUpperCase()<t.first.toUpperCase()?-1:1:e.last.toUpperCase()<t.last.toUpperCase()?-1:1:e.points-t.points),current_sort="ascend",sorts.set(e,"ascend"),rerender(e)}function rerender(e){if(is_search)for(let e in search_array){let t=search_array[e],n=document.getElementById(`${t.first}-${t.last}-${search_period}-row`);n.style.transform=`translateY(${60*(e-t.alpha_pos)}px)`,n.style.zIndex=""+(search_array.size-e)}else{let t=container.get(e);for(let n in t){let r=t[n],a=document.getElementById(`${r.first}-${r.last}-${e}-row`);a.style.transform=`translateY(${60*(n-r.alpha_pos)}px)`,a.style.zIndex=""+(t.size-n)}}}function rerenderAfterTabSearch(e){is_search=!1,$("#list-group-"+e).empty();var t=container.get(e.toString());for(const n of t){let t,r;$("#list-group-"+e).append(`\n            <li id="${n.first}-${n.last}-${e}-row"class="list-group-item d-flex">\n                <span class="flex-grow-1" style="text-align: center;">${n.first} ${n.last}</span>\n                <span id="${n.first}-${n.last}-${e}-change" style="text-align: center; width: 75px;">+0</span>\n                <input id="${n.first}-${n.last}-${e}-input" type="number" value="${n.points}" placeholder="0" min="0" step="1" style="text-align: center;width: 75px;" onclick="updateScore(event)">\n            </li>\n        `),n.points-n.init_points>0?(t="green",r="+"+(n.points-n.init_points)):n.points-n.init_points<0?(t="red",r=""+(n.points-n.init_points)):(t="grey",r="+0"),document.getElementById(`${n.first}-${n.last}-${e}-change`).innerHTML=r,document.getElementById(`${n.first}-${n.last}-${e}-change`).style.color=t}}function rerenderDuringTabSearch(e,t){if(0!=t.length){$("#list-group-"+e).empty(),search_array=[],search_period=e;var n=container.get(e.toString());for(const r of n)if(r.first.toUpperCase().includes(t.toUpperCase())||r.last.toUpperCase().includes(t.toUpperCase())){let t,n,a=Object.assign({},r);a.alpha_pos=search_array.length,search_array.push(a),$("#list-group-"+e).append(`\n                <li id="${r.first}-${r.last}-${e}-row" class="list-group-item d-flex">\n                    <span class="flex-grow-1" style="text-align: center;">${r.first} ${r.last}</span>\n                    <span id="${r.first}-${r.last}-${e}-change" style="text-align: center; width: 75px;">+0</span>\n                    <input id="${r.first}-${r.last}-${e}-input" type="number" value="${r.points}" placeholder="0" min="0" step="1" style="text-align: center;width: 75px;" onclick="updateScore(event)">\n                </li>\n            `),r.points-r.init_points>0?(t="green",n="+"+(r.points-r.init_points)):r.points-r.init_points<0?(t="red",n=""+(r.points-r.init_points)):(t="grey",n="+0"),document.getElementById(`${r.first}-${r.last}-${e}-change`).innerHTML=n,document.getElementById(`${r.first}-${r.last}-${e}-change`).style.color=t}is_search=!0}else rerenderAfterTabSearch(e)}function switchTab(e){is_search=!1;let t=document.getElementById(e+"-searchbar").value;0!=t&&(is_search=!0,rerenderDuringTabSearch(e,t)),current_sort=sorts.get(e)}function updateScore(e){let t,[n,r,a]=e.target.id.split("-");switch(is_search?(t=search_array.find(e=>e.first==n&&e.last==r),container.get(a).find(e=>e.first==n&&e.last==r).points=parseInt(e.target.value)):t=container.get(a).find(e=>e.first==n&&e.last==r),t.points=parseInt(e.target.value),t.points-t.init_points>0?(document.getElementById(`${t.first}-${t.last}-${a}-change`).innerHTML="+"+(t.points-t.init_points),document.getElementById(`${t.first}-${t.last}-${a}-change`).style.color="green"):t.points-t.init_points<0?(document.getElementById(`${t.first}-${t.last}-${a}-change`).innerHTML=""+(t.points-t.init_points),document.getElementById(`${t.first}-${t.last}-${a}-change`).style.color="red"):(document.getElementById(`${t.first}-${t.last}-${a}-change`).innerHTML="+0",document.getElementById(`${t.first}-${t.last}-${a}-change`).style.color="grey"),storeData(),current_sort){case"alpha":sortAlphaTab(a);break;case"descend":sortDescendTab(a);break;case"ascend":sortAscendTab(a)}}function renderFirst(){sortAlpha();var e=!0;for(var[t,n]of container){e?($("#tablist").append(`\n                <li class="nav-item" role="presentation">\n                    <a onclick="switchTab('${t}')" class="nav-link active" role="tab" data-toggle="tab" href="#tab-${t}">Period ${t}</a>\n                </li>\n            `),$("#tab-content").append(`\n                <div class="tab-pane fade show active" role="tabpanel" id="tab-${t}">\n                    <input id="${t}-searchbar" oninput="rerenderDuringTabSearch('${t}', event.target.value)" type="search" class="form-control-lg" style="width: 100%;color: rgb(45,46,55);border: 1px solid rgb(67,67,67);text-align: center; height: 5vh;" placeholder="Search Names" />\n                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons" style="height: 5vh">\n                        <label class="btn btn-outline-primary active" for="btnradio1-${t}" style="border-radius: 0;" onclick=sortAlphaTab('${t}')>\n                            <input type="radio" name="btnradio-${t}" checked id="btnradio1-${t}">\n                            A -> Z\n                        </label>\n                        <label class="btn btn-outline-primary" for="btnradio2-${t}" style="border-radius: 0;" onclick=sortDescendTab('${t}')>\n                            <input type="radio" class="btn-check" name="btnradio-${t}" id="btnradio2-${t}">\n                            +4, ..., -5\n                        </label>\n                        <label class="btn btn-outline-primary" for="btnradio3-${t}" style="border-radius: 0;" onclick=sortAscendTab('${t}')>\n                            <input type="radio" name="btnradio-${t}" id="btnradio3-${t}">\n                            1, 2, ...\n                        </label>\n                    </div>\n                    <ul class="list-group text-monospace border rounded-0" id="list-group-${t}" style="height: 60vh;overflow-y: auto;">\n                        \n                    </ul>\n                </div>\n            `),e=!1):($("#tablist").append(`\n                <li class="nav-item" role="presentation">\n                    <a onclick="switchTab('${t}')" class="nav-link" role="tab" data-toggle="tab" href="#tab-${t}">Period ${t}</a>\n                </li>\n            `),$("#tab-content").append(`\n            <div class="tab-pane fade" role="tabpanel" id="tab-${t}">\n                <input id="${t}-searchbar" oninput="rerenderDuringTabSearch('${t}', event.target.value)" type="search" class="form-control-lg" style="width: 100%;color: rgb(45,46,55);border: 1px solid rgb(67,67,67);text-align: center; height: 5vh;" placeholder="Search Names" />\n                <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons" style="height: 5vh">\n                    <label class="btn btn-outline-primary active" for="btnradio1-${t}" style="border-radius: 0;" onclick=sortAlphaTab('${t}')>\n                        <input type="radio" name="btnradio-${t}" checked id="btnradio1-${t}">\n                        A -> Z\n                    </label>\n                    <label class="btn btn-outline-primary" for="btnradio2-${t}" style="border-radius: 0;" onclick=sortDescendTab('${t}')>\n                        <input type="radio" class="btn-check" name="btnradio-${t}" id="btnradio2-${t}">\n                        +4, ..., -5\n                    </label>\n                    <label class="btn btn-outline-primary" for="btnradio3-${t}" style="border-radius: 0;" onclick=sortAscendTab('${t}')>\n                        <input type="radio" name="btnradio-${t}" id="btnradio3-${t}">\n                        1, 2, ...\n                    </label>\n                </div>\n                <ul class="list-group text-monospace border rounded-0" id="list-group-${t}" style="height: 60vh;overflow-y: auto;">\n                    \n                </ul>\n            </div>\n            `));for(const e of n)$("#list-group-"+t).append(`\n                <li id="${e.first}-${e.last}-${t}-row"class="list-group-item d-flex">\n                    <span class="flex-grow-1" style="text-align: center;">${e.first} ${e.last}</span>\n                    <span id="${e.first}-${e.last}-${t}-change" style="text-align: center; width: 75px; color: grey;">+0</span>\n                    <input id="${e.first}-${e.last}-${t}-input" type="number" value="${e.points}" placeholder="0" min="0" step="1" style="text-align: center;width: 75px;" onchange="updateScore(event)">\n                </li>\n            `)}}function writeModal(){var e=[];for(var[t,n]of container)for(var r in n){var a=new Object(null);a.period=t,a.first=n[r].first,a.last=n[r].last,a.points=n[r].points,e.push(a)}document.getElementById("csv-out").innerText="\n"+$.csv.fromObjects(e)}function downloadModal(){var e=document.getElementById("csv-out").innerText.replace(/^\n/,""),t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","points.csv"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}document.getElementById("copy-button").addEventListener("click",e=>{navigator.clipboard.writeText(document.getElementById("csv-out").innerText.replace(/^\n/,"")),e.target.innerText="Copied",setTimeout(()=>{document.getElementById("copy-button").innerText="Copy"},3e3)}),document.getElementById("file-input-clickable").addEventListener("change",readFile,!1),document.getElementById("file-input").addEventListener("click",()=>{document.getElementById("file-input-clickable").click()}),document.getElementById("text-input").addEventListener("click",()=>{readText()}),document.getElementById("cache-input").addEventListener("click",()=>{openDBandRead()}),document.getElementById("open-export-modal").addEventListener("click",()=>{writeModal()}),document.getElementById("download-csv").addEventListener("click",()=>{downloadModal()});